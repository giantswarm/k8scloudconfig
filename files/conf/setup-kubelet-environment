#!/bin/bash
env_file="/etc/kubelet-environment"

# set max pods variable
{{ if or (.AWSCiliumENIMode) (and .EnableAWSCNI (eq .AWSCNISubnetPrefixMode false)) -}}
# The maximum number of pods on AWS with aws-cni is defined by maximum ENI for instance and maximum IPs per ENI. Check this link
# This is just simplifying the whole formula. Small instances can have less ENIs and less IPs per ENI.
# https://github.com/aws/amazon-vpc-cni-k8s#eni-allocation
# https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-eni.html

instance_type="$(/opt/imds-client /latest/meta-data/instance-type)"

# Cases are generated with:
#
#    curl -fsSLo - https://raw.githubusercontent.com/awslabs/amazon-eks-ami/2e1f63f951c82a76fd20b19b811592535962c82d/files/eni-max-pods.txt | grep -v '^#' | sed -E 's/([[:alnum:]]+)[[:space:]]+([[:digit:]]+)/\1)|MAX_PODS=$((\2|- $reserved_ips)) ;;/' | column -t -s '|'
#
if [ $1 == "master" ]; then
  # 1 ENI for the node, 1 for ETCD
  reserved_eni=2
else
  # 1 ENI for the node
  reserved_eni=1
fi

# Formula for max amount of pods in AWS CNI is (enis-$reserved_enis)*(ips_eni-1)+$host_network_pods
# As host network pods reuse the ip of the node, it doesn't count against the AWS CNI quota.

case $instance_type in
a1.medium)      MAX_PODS=$(((2 - $reserved_eni) * (4-1)))     ;;
a1.large)       MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
a1.xlarge)      MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
a1.2xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
a1.4xlarge)     MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
a1.metal)       MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
c1.medium)      MAX_PODS=$(((2 - $reserved_eni) * (6-1)))     ;;
c1.xlarge)      MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
c3.large)       MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
c3.xlarge)      MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
c3.2xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
c3.4xlarge)     MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
c3.8xlarge)     MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
c4.large)       MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
c4.xlarge)      MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
c4.2xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
c4.4xlarge)     MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
c4.8xlarge)     MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
c5.large)       MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
c5.xlarge)      MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
c5.2xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
c5.4xlarge)     MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
c5.9xlarge)     MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
c5.12xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
c5.18xlarge)    MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
c5.24xlarge)    MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
c5.metal)       MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
c5a.large)      MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
c5a.xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
c5a.2xlarge)    MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
c5a.4xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
c5a.8xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
c5a.12xlarge)   MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
c5a.16xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
c5a.24xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
c5d.large)      MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
c5d.xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
c5d.2xlarge)    MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
c5d.4xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
c5d.9xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
c5d.12xlarge)   MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
c5d.18xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
c5d.24xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
c5d.metal)      MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
c5n.large)      MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
c5n.xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
c5n.2xlarge)    MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
c5n.4xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
c5n.9xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
c5n.18xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
c5n.metal)      MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
c6g.medium)     MAX_PODS=$(((2 - $reserved_eni) * (4-1)))     ;;
c6g.large)      MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
c6g.xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
c6g.2xlarge)    MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
c6g.4xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
c6g.8xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
c6g.12xlarge)   MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
c6g.16xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
c6g.metal)      MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
c6i.large)      MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
c6i.xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
c6i.2xlarge)    MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
c6i.4xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
c6i.9xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
c6i.12xlarge)   MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
c6i.18xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
c6i.24xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
c6i.metal)      MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
cc2.8xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
cr1.8xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
d2.xlarge)      MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
d2.2xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
d2.4xlarge)     MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
d2.8xlarge)     MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
f1.2xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
f1.4xlarge)     MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
f1.16xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (50-1)))    ;;
g2.2xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
g2.8xlarge)     MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
g3s.xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
g3.4xlarge)     MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
g3.8xlarge)     MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
g3.16xlarge)    MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
g4dn.xlarge)    MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
g4dn.2xlarge)   MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
g4dn.4xlarge)   MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
g4dn.8xlarge)   MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
g4dn.12xlarge)  MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
g4dn.16xlarge)  MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
g4ad.xlarge)    MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
g4ad.2xlarge)   MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
g4ad.4xlarge)   MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
g4ad.8xlarge)   MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
g4ad.12xlarge)  MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
g4ad.16xlarge)  MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
g4dn.metal)     MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
h1.2xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
h1.4xlarge)     MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
h1.8xlarge)     MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
h1.16xlarge)    MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
hs1.8xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
i2.xlarge)      MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
i2.2xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
i2.4xlarge)     MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
i2.8xlarge)     MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
i3.large)       MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
i3.xlarge)      MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
i3.2xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
i3.4xlarge)     MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
i3.8xlarge)     MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
i3.16xlarge)    MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
i3.metal)       MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
i3en.large)     MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
i3en.xlarge)    MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
i3en.2xlarge)   MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
i3en.3xlarge)   MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
i3en.6xlarge)   MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
i3en.12xlarge)  MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
i3en.24xlarge)  MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
i3en.metal)     MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
inf1.xlarge)    MAX_PODS=$(((4 - $reserved_eni) * (10-1)))    ;;
inf1.2xlarge)   MAX_PODS=$(((4 - $reserved_eni) * (10-1)))    ;;
inf1.6xlarge)   MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
inf1.24xlarge)  MAX_PODS=$(((15 - $reserved_eni) * (30-1)))   ;;
m1.small)       MAX_PODS=$(((2 - $reserved_eni) * (4-1)))     ;;
m1.medium)      MAX_PODS=$(((2 - $reserved_eni) * (6-1)))     ;;
m1.large)       MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
m1.xlarge)      MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
m2.xlarge)      MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
m2.2xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (30-1)))    ;;
m2.4xlarge)     MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
m3.medium)      MAX_PODS=$(((2 - $reserved_eni) * (6-1)))     ;;
m3.large)       MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
m3.xlarge)      MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
m3.2xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (30-1)))    ;;
m4.large)       MAX_PODS=$(((2 - $reserved_eni) * (10-1)))    ;;
m4.xlarge)      MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
m4.2xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
m4.4xlarge)     MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
m4.10xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
m4.16xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
m5.large)       MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
m5.xlarge)      MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
m5.2xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
m5.4xlarge)     MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
m5.8xlarge)     MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
m5.12xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
m5.16xlarge)    MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
m5.24xlarge)    MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
m5.metal)       MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
m5a.large)      MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
m5a.xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
m5a.2xlarge)    MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
m5a.4xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
m5a.8xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
m5a.12xlarge)   MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
m5a.16xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
m5a.24xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
m5ad.large)     MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
m5ad.xlarge)    MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
m5ad.2xlarge)   MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
m5ad.4xlarge)   MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
m5ad.8xlarge)   MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
m5ad.12xlarge)  MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
m5ad.16xlarge)  MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
m5ad.24xlarge)  MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
m5d.large)      MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
m5d.xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
m5d.2xlarge)    MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
m5d.4xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
m5d.8xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
m5d.12xlarge)   MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
m5d.16xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
m5d.24xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
m5d.metal)      MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
m5dn.large)     MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
m5dn.xlarge)    MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
m5dn.2xlarge)   MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
m5dn.4xlarge)   MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
m5dn.8xlarge)   MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
m5dn.12xlarge)  MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
m5dn.16xlarge)  MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
m5dn.24xlarge)  MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
m5n.large)      MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
m5n.xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
m5n.2xlarge)    MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
m5n.4xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
m5n.8xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
m5n.12xlarge)   MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
m5n.16xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
m5n.24xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
m5zn.large)      MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
m5zn.xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
m5zn.2xlarge)    MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
m5zn.4xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
m5zn.8xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
m5zn.12xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))    ;;
m6a.large)      MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
m6a.xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
m6a.2xlarge)    MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
m6a.4xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
m6a.8xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
m6a.12xlarge)   MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
m6a.16xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
m6a.24xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
m6a.32xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
m6a.48xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
m6i.large)      MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
m6i.xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
m6i.2xlarge)    MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
m6i.4xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
m6i.8xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
m6i.12xlarge)   MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
m6i.16xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
m6i.24xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
m6i.32xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
m6i.48xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
m6g.medium)     MAX_PODS=$(((2 - $reserved_eni) * (4-1)))     ;;
m6g.large)      MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
m6g.xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
m6g.2xlarge)    MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
m6g.4xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
m6g.8xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
m6g.12xlarge)   MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
m6g.16xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
m6g.metal)      MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
p2.xlarge)      MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
p2.8xlarge)     MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
p2.16xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
p3.2xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
p3.8xlarge)     MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
p3.16xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
p3dn.24xlarge)  MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
p4d.24xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
r3.large)       MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
r3.xlarge)      MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
r3.2xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
r3.4xlarge)     MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
r3.8xlarge)     MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
r4.large)       MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
r4.xlarge)      MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
r4.2xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
r4.4xlarge)     MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
r4.8xlarge)     MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
r4.16xlarge)    MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
r5.large)       MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
r5.xlarge)      MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
r5.2xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
r5.4xlarge)     MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
r5.8xlarge)     MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
r5.12xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
r5.16xlarge)    MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
r5.24xlarge)    MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
r5.metal)       MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
r5a.large)      MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
r5a.xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
r5a.2xlarge)    MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
r5a.4xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
r5a.8xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
r5a.12xlarge)   MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
r5a.16xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
r5a.24xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
r5ad.large)     MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
r5ad.xlarge)    MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
r5ad.2xlarge)   MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
r5ad.4xlarge)   MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
r5ad.8xlarge)   MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
r5ad.12xlarge)  MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
r5ad.16xlarge)  MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
r5ad.24xlarge)  MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
r5b.large)      MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
r5b.xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
r5b.2xlarge)    MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
r5b.4xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
r5b.8xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
r5b.12xlarge)   MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
r5b.16xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
r5b.24xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
r5b.metal)      MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
r5d.large)      MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
r5d.xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
r5d.2xlarge)    MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
r5d.4xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
r5d.8xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
r5d.12xlarge)   MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
r5d.16xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
r5d.24xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
r5d.metal)      MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
r5dn.large)     MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
r5dn.xlarge)    MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
r5dn.2xlarge)   MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
r5dn.4xlarge)   MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
r5dn.8xlarge)   MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
r5dn.12xlarge)  MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
r5dn.16xlarge)  MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
r5dn.24xlarge)  MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
r5n.large)      MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
r5n.xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
r5n.2xlarge)    MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
r5n.4xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
r5n.8xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
r5n.12xlarge)   MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
r5n.16xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
r5n.24xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
r6g.medium)     MAX_PODS=$(((2 - $reserved_eni) * (4-1)))     ;;
r6g.large)      MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
r6g.xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
r6g.2xlarge)    MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
r6g.4xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
r6g.8xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
r6g.12xlarge)   MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
r6g.16xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
r6g.metal)      MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
r6i.large)      MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
r6i.xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
r6i.2xlarge)    MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
r6i.4xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
r6i.8xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
r6i.12xlarge)   MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
r6i.16xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
r6i.24xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
r6i.metal)      MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
t1.micro)       MAX_PODS=$(((2 - $reserved_eni) * (2-1)))     ;;
t2.nano)        MAX_PODS=$(((2 - $reserved_eni) * (2-1)))     ;;
t2.micro)       MAX_PODS=$(((2 - $reserved_eni) * (2-1)))     ;;
t2.small)       MAX_PODS=$(((3 - $reserved_eni) * (4-1)))     ;;
t2.medium)      MAX_PODS=$(((3 - $reserved_eni) * (6-1)))     ;;
t2.large)       MAX_PODS=$(((3 - $reserved_eni) * (12-1)))    ;;
t2.xlarge)      MAX_PODS=$(((3 - $reserved_eni) * (15-1)))    ;;
t2.2xlarge)     MAX_PODS=$(((3 - $reserved_eni) * (15-1)))    ;;
t3.nano)        MAX_PODS=$(((2 - $reserved_eni) * (2-1)))     ;;
t3.micro)       MAX_PODS=$(((2 - $reserved_eni) * (2-1)))     ;;
t3.small)       MAX_PODS=$(((3 - $reserved_eni) * (4-1)))     ;;
t3.medium)      MAX_PODS=$(((3 - $reserved_eni) * (6-1)))     ;;
t3.large)       MAX_PODS=$(((3 - $reserved_eni) * (12-1)))    ;;
t3.xlarge)      MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
t3.2xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
t3a.nano)       MAX_PODS=$(((2 - $reserved_eni) * (2-1)))     ;;
t3a.micro)      MAX_PODS=$(((2 - $reserved_eni) * (2-1)))     ;;
t3a.small)      MAX_PODS=$(((2 - $reserved_eni) * (4-1)))     ;;
t3a.medium)     MAX_PODS=$(((3 - $reserved_eni) * (6-1)))     ;;
t3a.large)      MAX_PODS=$(((3 - $reserved_eni) * (12-1)))    ;;
t3a.xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
t3a.2xlarge)    MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
u-6tb1.metal)   MAX_PODS=$(((5 - $reserved_eni) * (30-1)))    ;;
u-9tb1.metal)   MAX_PODS=$(((5 - $reserved_eni) * (30-1)))    ;;
u-12tb1.metal)  MAX_PODS=$(((5 - $reserved_eni) * (30-1)))    ;;
u-18tb1.metal)  MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
u-24tb1.metal)  MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
x1.16xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
x1.32xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
x1e.xlarge)     MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
x1e.2xlarge)    MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
x1e.4xlarge)    MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
x1e.8xlarge)    MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
x1e.16xlarge)   MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
x1e.32xlarge)   MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
z1d.large)      MAX_PODS=$(((3 - $reserved_eni) * (10-1)))    ;;
z1d.xlarge)     MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
z1d.2xlarge)    MAX_PODS=$(((4 - $reserved_eni) * (15-1)))    ;;
z1d.3xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
z1d.6xlarge)    MAX_PODS=$(((8 - $reserved_eni) * (30-1)))    ;;
z1d.12xlarge)   MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
z1d.metal)      MAX_PODS=$(((15 - $reserved_eni) * (50-1)))   ;;
*)              MAX_PODS=40 ;;
esac

## We don't want to have more than 110 pods on a node even it would be possible by IP's.
if [ "$MAX_PODS" -gt "110" ];then
  MAX_PODS=110
fi

{{ else -}}
MAX_PODS=110
{{ end -}}

echo "MAX_PODS=${MAX_PODS}" >> ${env_file}
